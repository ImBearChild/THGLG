---
title: "使用 shell"
---

# 使用 Shell

## 前言

**不论你使用的是哪种发行版，你总是会面对使用 Shell 控制系统的时候。本文将描述如何使用命令行界面控制系统。**

- 在此感谢 [Christopher Negus](https://www.wiley.com/en-us/search?pq=%7Crelevance%7Cauthor%3AChristopher+Negus) 先生所写的《[Linux Bible, 10th Edition](https://www.wiley.com/en-us/Linux+Bible%2C+10th+Edition-p-9781119578895)》，本文也是基于此书所成。
- 你已经是一个成熟的 Linux 用户了，遇到本文没有提到的内容要学会自己去看源文档。
- 在终端中使用的命令普遍情况下不包含中文标点符号。

在图形化界面普及之前，电脑操作人员都是在命令行界面（CLI）中使用命令和计算机进行交互。

在 Linux 中，用于解释，管理命令的程序被称之为 **shell**。shell 提供了一个创建可执行脚本文件、运行程序、与文件系统进行交互、编译源码和管理计算机系统的办法。虽然命令行界面不太直观，但 shell 可以简单明了地配置许多并不存在于图形化界面中的设置参数，许多 Linux 专家认为命令行的效率高于图形化界面。

本文所描述的内容都是基于 **bash shell**，有关其他 shell 的使用方法请自行查阅资料。

## 关于 shell 与终端窗口

Linux 上访问 shell 界面的方法有很多，其中最常见的三种办法是：shell 提示符、终端窗口、虚拟控制台。

### 使用 shell 提示符

如果你安装的系统没有安装图形化界面，你登录系统后就会看到类似于：

```
Red Hat Enterprise Linux Server release 8.0 (Ootpa)
Kernel 4.18.0-42.el8.x86_64 on an X86
mylinuxhost login:
```

在此，你可以使用你的用户名和密码登录系统。

shell 的 `$` 提示符号表示当前为普通用户登录，`#` 提示符号表示当然前为 root 用户登录。

```
$ cp ~/Downloads/Tela-dark ~   #不需要管理员权限
# cp ~/Downloads/Tela-dark /usr/share/icons  #需要管理员权限
```

以上例子是将用户目录的下载文件（`~/Downloads`）内的 `Tela-dark` 的文件夹复制到两个地方，一个是用户目录（`~`），一个是共享文件夹（`/usr/share/icons`）。在命令的末尾，由 `#` 加文字组成的字符串是注释，注释不会被执行，但是有益于向读者解释当前命令或源码的含义。

### 使用虚拟控制台

大多数带有桌面环境的 Linux 发行版会在运行过程中启用多个虚拟控制台（virtual consoles），虚拟控制台是一个同时使用多个 shell 会话的办法。

你可以使用 `Ctrl` + `Alt` + `F1`~`F6` 快捷键组合在多个虚拟控制台间切换。要回到图形化界面，你只需要按下 `Ctrl` + `Alt` + `F1` 即可，一般而言，GUI 会在第一或第二个虚拟控制台运行，其他的虚拟控制台通常是命令行界面。

在切换到其他虚拟控制台后，你可以输入用户名和密码登录 shell，或者键入 `exit` 退出 shell 会话。

### 使用终端

一般而言，Linux 桌面都会有自己的终端模拟器。打开桌面环境自带的终端应用程序（它一般叫“终端”或者“Terminal”），你就能直接看到一个命令行界面（CLI）提示符，例如：

```
[bh@c004-v1 ~]$
```

`bh` 是 Linux 用户的用户名，`c004-v1` 是 Linux 用户的主机名，`~` 表示 Linux 用户当前所在的文件夹是用户目录，即 `/home/bh`。要退出，你只需要关闭窗口或者键入 `exit` 即可。

- 注意，直接关闭终端窗口会导致该窗口运行的程序或命令终止。

要在终端中运行命令，只需要在提示符后输入命令，然后按下 `Enter` 键即可，如：

```
[bh@c004-v1 ~]$ date
2022年 01月 17日 星期一 17:14:31 CST
[bh@c004-v1 A1]$ echo Hello World!
Hello World!
```

`date` 命令可以用于显示当前的系统时间，日期和时区（输出内容的格式与你设置的语言和地区有关系）。相同命令还有 `uptime`，用于查看系统的开机时间。`echo` 命令可以将你输入的内容打印在屏幕上。

```
[bh@c004-v1 ~]$ uptime
 17:16:26 up 9 min,  1 user,  load average: 0.05, 0.12, 0.11
```

如上，系统于 `17:16:26` 开机，已开机 9 分钟，共有一个已登录用户（`bh`），1 分钟，5 分钟和 15 分钟内的系统平均负载分别是 0.05、0.12 和 0.11。

系统负载（System Load）是系统 CPU 繁忙程度的度量，即有多少进程在等待被 CPU 调度（进程等待队列的长度）。平均负载（Load Average）是一段时间内系统的平均负载，这个一段时间一般取 1 分钟、5 分钟、15 分钟。

假设你的 CPU 是单核，它在单位时间内的事件处理能力有限的，当它被待处理事件填满，满负载运作的时候，load = 1；小于表示 CPU 未满载，大于 1 则表示超载工作，此时 CPU 不仅需要处理当前事务，还有更多的事务正在排队等待处理。如果你有一个四核 CPU，则当 load = 4 时，表示你的四个 CPU 核心均在满负载工作。对于单核 CPU，当 load 超过 1 时，你应该检查一下什么东西占用了大量的 CPU 资源，以此类推。

此外还有几个命令值得一试：

```
[bh@c004-v1 ~]$ pwd
/home/bh
[bh@c004-v1 ~]$ hostname
c004-v1
[bh@c004-v1 ~]$ ls
公共  模板  视频  图片  文档  下载  音乐  桌面  Applications
```

`pwd` 即，print working directory（打印你当前所在的文件夹至输出结果），`hostname` 用于显示你的主机名，`ls` 用于显示你所在文件夹的所有文件。

## 运行命令

### 命令的语法

大多数命令都有一个或多个选项（option），你可以通过添加选项来改变命令的执行方式。

选项通常由一个前面带有连字符（`-`）的单个字母组成。你可以将单个字母选项组合在一起，或者在每个选项前面加上连字符以使用多个一次一个选项。例如下面两个使用 ls 命令的选项，效果是相同的：

```
$ ls -l -a -t
$ ls -lat
```

如上，你使用了 `-l`（长列表）、`-a`（显示包括隐藏文件在内的全部文件和文件夹）、`-t`（按时间排序） 修改了 `ls` 的运行模式。`ls` 命令用于显示当前目录的所有常规文件（默认不显示隐藏内容，即以 `.` 开头的文件或文件夹）。

一些命令的选项可能会使用单个单词来表示，要使用这些选项，你需要使用两个连字符（`--`），如 `--help`。如果没有这么做，系统尝试将这个单词理解成多个选项缩写字母组合在一起的选项。你可以将 `--help` 附加在绝大多数命令的后面，来获取有关该命令定义的选项和参数（argument）信息，例如：`uptime --help`。

许多命令会使用参数（argument），这些参数通常紧跟在选项的后面或者整个命令的末尾。参数本质是一条额外的信息，它可能是文件名、目录、用户名、设备或者其他东西，用于告知系统应该执行什么操作。例如：`cat /etc/hosts` 会将 `/etc/hosts` 中包含的信息打印在你的屏幕上，`/etc/hosts` 就是一个参数。你可以在命令行中输入很多个参数（数量取决于单行的字符数量限制）。

有时候，参数也会和选项联系在一起，此时，参数必须紧跟在选项的后面。如果选项是单个字母，请使用空格将参数与选项分割开，如果选项是一个单词，请使用等号将其连接起来，例如：

```
[bh@c004-v1 ~]$ ls --hide=FolderA
公共  模板  视频  图片  文档  下载  音乐  桌面  Applications
[bh@c004-v1 ~]$ ls
公共  模板  视频  图片  文档  下载  音乐  桌面  Applications  FolderA
```

如上，`--hide` 选项让 `ls` 在读取紧随其后的参数后，从输入结果中隐藏了 FolderA 文件夹。请注意，选项和参数用等号连接起来，中间不要有空格。

```
$ tar -cvf test.tar FolderA
```

如上，这是一个单字母选项用空格连接一个参数的例子。这条命令表示使用 `tar` 命令创建（`c`）一个名为 `test.tar` 的文件（`f`），并在创建备份时显示详细 (verbose，`v`) 消息；该文件包含 FolderA 文件夹中的所有子文件夹和文件（该命令还使用了相对路径，有关于此，将在后文详述）。因为 `test.tar` 是 `-f` 选项的参数，所以 `test.tar` 必须紧随其后（用空格隔开）。

你还可以使用 `uname` 查看系统版本，加上 `-a` 还可以查看内核版本，主机名，uptime 等信息，如下：

```
[bh@c004-v1 ~]$ uname -a
Linux c004-v1 5.15.14-200.fc35.x86_64 #1 SMP Tue Jan 11 16:49:27 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux
```

`id` 可用于查看你的用户名，加入的用户组，`who` 可以用于查阅你的用户名，登录的终端和时间，类似的还有 `whoami`。如下：

```
[bh@c004-v1 ~]$ who
bh       tty1         2022-01-17 17:06 (:0)
[bh@c004-v1 ~]$ id
用户id=1000(bh) 组id=1000(bh) 组=1000(bh),10(wheel) 上下文=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
```

如上，当你登录 Linux 的时候，Linux 会使用一系列的信息（用户名，组名，ID 等）识别你，跟踪你的活动。在此例中，数字化的用户 ID（UID）是 1000，用户 `bh` 所在的主要用户组是 `bh`，其组 ID（gid）是 1000。`bh` 还是 `wheel` 组（gid=10）的成员（即系统管理员）。

- 一般而言，用户所在的组应该是 `users`，但 Fedora 和 RHEL 及其衍生发行版都是采用 [User Private Groups](https://web.mit.edu/rhel-doc/3/rhel-rg-en-3/s1-users-groups-private-groups.html)，所以用户名通常和用户首要组相同。

当你输入一堆的命令后，你可以使用 `clear` 清空整个屏幕

### 定位命令的位置

你在 Linux 上所输入的命令一般都存储在你的路径（path）中，对于不在路径中的命令，你可以输入命令位置的完整标识。

为了方便起见，建议将你自己创建或使用的自定义命令放置到路径中，然后将这些目录添加到 shell 的 `PATH` 环境变量中。该路径由一系列目录组成，这些目录会按顺序检查你输入的命令。要查看这些目录，请运行：

```
[bh@c004-v1 ~]$ echo $PATH
/home/bh/.local/bin:/home/bh/bin:/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin
```

以上显示了一个 Linux 用户默认的路径位置，位于路径中的文件夹用 `:` 分隔开来。大多数用户命令都存储在 `/bin`、`/usr/bin` 和 `/usr/local/bin` 目录中，`usr/local/sbin` 和 `/usr/sbin` 目录储存管理员命令（一些 Linux 系统不会把这些东西放在普通用户的目录中）。最开始的两个目录（`~/.local/bin` 和 `~/bin`）是位于用户目录中的文件夹。

Linux 不像其他系统（如 Windows）会在执行命令前会先检查当前目录是否含有可执行文件或命令，而是先检查 `PATH` 变量所包含的文件夹。要执行当前文件夹的命令，你必须指定他们的绝对路径，如运行 `$ ./home/bh/Applications/Mount.sh` 执行一个用户存放于 `~/Applications` 的自定义 shell 脚本。

`PATH` 变量中，文件夹的排序是很重要的。系统会从左往右逐个检查 `PATH` 中包含文件夹，如果你有两个相同名称但存储于不同目录的文件，那么系统会先执行首先检索到的命令，如果要执行另一个命令，你需要指定该命令所在的完整目录地址，或者修改 `PATH` 变量（后续将详述）。

除了存储在 `PATH` 变量中的文件夹的命令，一些命令内置在 shell 中。可以通过创建定义你希望该命令运行的任何命令和选项的别名来覆盖其他命令。还有一些方法可以定义由一系列存储的命令组成的函数。系统一般以以下顺序检查你输入的命令：

1. **Aliases**（别名），这些是由 `alias` 命令设置的名称，代表特定的命令和一组选项。你可以使用 `alias` 为长而复杂的命令定义一个短名称，相关内容将在后续详述。
2. **Shell reserved word**（shell 保留字词），其中许多是您将在编程类型函数中使用的词，例如 `do`、`while`、`case` 和 `else`。
3. **Function**（函数），这是一组在当前 shell 中一起执行的命令。
4. **Built-in command**（内置命令），这是一些内置于 shell 中的命令，例如 `cd`（更改目录）、`echo`（将文本输出到屏幕）、`exit`（退出 shell）等。
5. **Filesystem command**（文件系统命令），该命令存储在计算机的文件系统中并从其执行。（这些是由 PATH 变量的值指示的命令。）

你可以使用 `type` 命令确定某个命令的位置，如

```
[bh@c004-v1 ~]$ type cd
cd 是 shell 内建
[bh@c004-v1 ~]$ type dnf
dnf 是 /usr/bin/dnf
```

如果一个命令同时存储于多个文件夹，你可以使用 `-a` 选项列出这些目录，如 `$ type -a ls`,列举出 `ls` 的全部位置和别名。

如果你遇到命令不存在或访问被拒绝的情况，如果命令不存在，请检查你的命令是否拼写正确以及它是否位于 `PATH` 变量的目录中，或你是否安装了包含该命令的软件包；如果访问被拒绝，请检查你是否有相应的权限执行该命令。

如果某个目录不存在于你的 `PATH` 变量中，你可以使用 `locate` 查询整个系统所有的文件夹（你可以访问的部分），要查找某些文件夹（如 `/root/bin`），你需要 `root` 权限。

## 查询命令使用历史

人是有极限的，记不住太多的东西。所以你需要知道如何查询你之前干了什么，以及那一串长长的字母究竟是怎么打才能正确运行。

你可以使用 `history` 查询你最近输过的命令。然后用鼠标选中复制，然后使用 `Ctrl` + `Shift` + `V` 快捷键组合将内容复制到终端中。或者你可以使用方向键 `↑` 和 `↓` 显示你之前输过的命令。然后使用 `←` 和 `→` 移动光标，编辑命令。

### 命令行编辑

bash shell 支持基于 [emacs](https://www.gnu.org/software/emacs/) 文本编辑器的命令行编辑功能（你可以输入 `man emacs` 查阅相关用户手册了解更多信息，要关闭手册按，只需要按 `q` 即可退出）来编辑你输入的命令。

### 命令行补全

bash shell 提供了几种不同的方法来补全部分键入的值。要尝试完成一个值，请键入前几个字符并按 `Tab` 键。以下是你可以从 bash shell 中部分键入的一些值：

- **命令，别名或函数**  如果你键入的文本以常规字符开头，shell 会尝试使用命令、别名或函数名来完成文本。
- **变量**  如果你键入的文本以 `$` 开头，shell 补齐变量。
- **用户名**  如果你键入的文本以 `~` 开头，shell 会使用用户名（username）补齐文本。例如 `cd ~`，移动到当前用户的家目录。
- **主机名**  如果你键入的文本以 `@` 开头，shell 会使用 `/etc/hosts` 文件中的主机名补齐文本。

```
[bh@c004-v1 ~]$ echo $P<Tab>
$PANEL_GDK_CORE_DEVICE_EVENTS  $PROMPT_COMMAND                $PS4
$PATH                          $PS0                           $PWD
$PIPESTATUS                    $PS1                           
$PPID                          $PS2  
[bh@c004-v1 ~]$ echo $P
```

如上，输入 `echo $P` 再按下 `Tab` 键，shell 会显示以 `$P` 开头的变量。在显示变量后，shell 会回到原本的位置 `echo $P`，你可以继续输入命令。

还有其他几个命令你可以试试看：

```
$ echo $OS<Tab>
$ cd ~ro<Tab>
$ userm<Tab>
```

### 命令行召回

你所输入的命令都会存储在 shell 的历史记录列表中，当你退出 shell 会话后，这些记录会存储到一个 history 文件中，以便下一次会话时查阅。

你可以使用 `history` + 数字显示你所希望看到的历史命令的数量，使用方向键 `↑` 和 `↓` 上下翻页，如：

```
[bh@c004-v1 ~]$ history 10
  326  cd ~
  327  ls
  328  sudo dnf up -y
  329  uptime
  330  id
  331  whoami
  332  type locate
  333  type ls
  334  cat /etc/hosts
  335  history 10
[bh@c004-v1 ~]$ !329
uptime
 11:06:42 up  2:04,  1 user,  load average: 0.14, 0.17, 0.10
```

然后使用 `!` + 数字的形式执行之前运行过的命令。你可以使用 `Ctrl` + `S` 搜索命令，执行或编辑结果。

## 连接和扩展命令